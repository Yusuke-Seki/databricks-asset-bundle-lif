permissions: &permissions
  permissions:
    # - group_name: steward
    #   level: CAN_MANAGE_RUN 
    - group_name: users
      level: CAN_VIEW

job_cluster: &job_cluster
  new_cluster:
    policy_id: ${var.job_cluster_policy}
    spark_version: 17.0.x-scala2.13
    driver_node_type_id: m5d.large
    node_type_id: m5d.large
    runtime_engine: STANDARD
    autoscale:
      min_workers: 1
      max_workers: 2
    aws_attributes:
      first_on_demand: 1
      availability: SPOT_WITH_FALLBACK
    custom_tags:
      bundle_name: datasteward_metadata_quality_dashboard

resources:
  jobs:
    task:
      name: metadata-quality-preprocessing-job
      <<: *permissions
      job_clusters:
        - job_cluster_key: metadata-quality-preprocessing-job-cluster
          <<: *job_cluster
      tasks:
        - task_key: deploy_udfs
          job_cluster_key: metadata-quality-preprocessing-job-cluster
          description: "UDFの作成／更新処理"
          notebook_task:
            notebook_path: ../src/deploy_udfs.ipynb
            base_parameters:
              SOURCE_CATALOG: ${var.source_catalog}
        - task_key: deploy_views
          depends_on:
            - task_key: deploy_udfs
          job_cluster_key: metadata-quality-preprocessing-job-cluster
          description: "ビューテーブル(データマート)の作成／更新処理"
          notebook_task:
            notebook_path: ../src/deploy_views.ipynb
            base_parameters:
              SOURCE_CATALOG: ${var.source_catalog}
